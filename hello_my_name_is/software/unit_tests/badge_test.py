"""***********************************************************
PROGRAM NAME:   badge_test.py
PROGRAMMER:     M. STRIDE, 2022-04-24
DESCRIPTION:    Tests the 'hello my name is' pcb badge
to verify all parts are functional.
TODO:           
BUGS:           
***********************************************************"""

import machine
import utime
import ssd1306 #save ssd1306 lib to pico first
import framebuf

#PINS
button_SW4_UP = machine.Pin(1, machine.Pin.IN)
button_SW5_DOWN = machine.Pin(0, machine.Pin.IN) 
sensor_RP2040_die_temp = machine.ADC(4)
oled_rst = machine.Pin(15, machine.Pin.OUT)

#SETUP
oled_rst.low()
utime.sleep(0.1)
oled_rst.high()
utime.sleep(0.1)

#I2C
i2c0 = machine.I2C(0, sda=machine.Pin(16), scl=machine.Pin(17), freq=400000)

oled = ssd1306.SSD1306_I2C(width=128, height=64, i2c=i2c0, addr=0x3C)

#GLOBAL VARS
adc_conversion_factor = 3.3 / (65535)
button_c = 0
prev_button_press = 0
#https://diyusthad.com/image2cpp
name_ms = bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\x80\x0f\x81\xc7\xff\xf8\x07\xc0\xf0\x0f\x00\x00\x00\x00\x00\x3f\x80\x1f\xc1\xc7\xff\xf8\x3f\xf0\xf0\x0f\x00\x00\x00\x00\x00\x3f\xc0\x1f\xc1\xc7\xff\xf8\x7f\xf8\xf0\x0f\x00\x00\x00\x00\x00\x3f\xc0\x3f\xc1\xc0\x1e\x00\xfc\x38\xf0\x0f\x00\x00\x00\x00\x00\x3d\xc0\x3b\xc1\xc0\x1e\x00\xf0\x08\xf0\x0f\x00\x00\x00\x00\x00\x3d\xe0\x7b\xc1\xc0\x1e\x01\xe0\x00\xf0\x0f\x00\x00\x00\x00\x00\x3d\xe0\x73\xc1\xc0\x1e\x01\xe0\x00\xf0\x0f\x00\x00\x00\x00\x00\x3c\xe0\x73\xc1\xc0\x1e\x01\xe0\x00\xf0\x0f\x00\x00\x00\x00\x00\x3c\xf0\xf3\xc1\xc0\x1e\x03\xe0\x00\xff\xff\x00\x00\x00\x00\x00\x3c\xf0\xe3\xc1\xc0\x1e\x03\xe0\x00\xff\xff\x00\x00\x00\x00\x00\x3c\x78\xe3\xc1\xc0\x1e\x03\xe0\x00\xff\xff\x00\x00\x00\x00\x00\x3c\x79\xe3\xc1\xc0\x1e\x03\xe0\x00\xf0\x0f\x00\x00\x00\x00\x00\x3c\x39\xc3\xc1\xc0\x1e\x01\xe0\x00\xf0\x0f\x00\x00\x00\x00\x00\x3c\x3f\xc3\xc1\xc0\x1e\x01\xe0\x00\xf0\x0f\x00\x00\x00\x00\x00\x3c\x3f\xc3\xc1\xc0\x1e\x01\xe0\x00\xf0\x0f\x00\x00\x00\x00\x00\x3c\x1f\x83\xc1\xc0\x1e\x01\xf0\x08\xf0\x0f\x00\x00\x00\x00\x00\x3c\x1f\x83\xc1\xc0\x1e\x00\xf8\x38\xf0\x0f\x00\x00\x00\x00\x00\x3c\x1f\x83\xc1\xc0\x1e\x00\x7f\xf8\xf0\x0f\x00\x00\x00\x00\x00\x3c\x0f\x03\xc1\xc0\x1e\x00\x3f\xf0\xf0\x0f\x00\x00\x00\x00\x00\x3c\x0f\x03\xc1\xc0\x1e\x00\x0f\xc0\xf0\x0f\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3f\x0f\xff\xf3\xff\x00\x70\x7f\xe0\x03\xff\x80\x00\x00\x00\x00\xff\xcf\xff\xf3\xff\xc0\x70\x7f\xfc\x07\xff\x80\x00\x00\x00\x01\xff\xcf\xff\xf3\xff\xe0\x70\x7f\xfe\x07\xff\x80\x00\x00\x00\x01\xe0\xc0\x3c\x03\xc1\xf0\x70\x78\x3f\x07\x80\x00\x00\x00\x00\x01\xe0\x00\x3c\x03\xc0\xf0\x70\x78\x0f\x87\x80\x00\x00\x00\x00\x03\xc0\x00\x3c\x03\xc0\xf0\x70\x78\x07\x87\x80\x00\x00\x00\x00\x01\xe0\x00\x3c\x03\xc0\xf0\x70\x78\x07\x87\x80\x00\x00\x00\x00\x01\xf8\x00\x3c\x03\xc0\xf0\x70\x78\x03\xc7\x80\x00\x00\x00\x00\x01\xfe\x00\x3c\x03\xc1\xe0\x70\x78\x03\xc7\xff\x00\x00\x00\x00\x00\xff\x80\x3c\x03\xff\xe0\x70\x78\x03\xc7\xff\x00\x00\x00\x00\x00\x3f\xc0\x3c\x03\xff\x80\x70\x78\x03\xc7\xff\x00\x00\x00\x00\x00\x0f\xc0\x3c\x03\xff\x80\x70\x78\x03\xc7\x80\x00\x00\x00\x00\x00\x03\xe0\x3c\x03\xc7\xc0\x70\x78\x03\xc7\x80\x00\x00\x00\x00\x00\x01\xe0\x3c\x03\xc3\xe0\x70\x78\x07\x87\x80\x00\x00\x00\x00\x00\x01\xe0\x3c\x03\xc1\xe0\x70\x78\x07\x87\x80\x00\x00\x00\x00\x02\x01\xe0\x3c\x03\xc1\xf0\x70\x78\x0f\x87\x80\x00\x00\x00\x00\x03\x83\xc0\x3c\x03\xc0\xf0\x70\x78\x3f\x07\x80\x00\x00\x00\x00\x03\xff\xc0\x3c\x03\xc0\xf0\x70\x7f\xfe\x07\xff\x80\x00\x00\x00\x01\xff\x80\x3c\x03\xc0\x78\x70\x7f\xfc\x07\xff\x80\x00\x00\x00\x00\x7e\x00\x3c\x03\xc0\x78\x70\x7f\xe0\x03\xff\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')


#FUNCTIONS
def button_test():
    print('Press any front button...')
    while True:
        if button_SW4_UP.value() == 0:
            print("You pressed the UP button")
        if button_SW5_DOWN.value() == 0:
            print("You pressed DOWN Button")
        utime.sleep(0.1)

def button_UP_pressed(pin):   #ISR
    global button_c, prev_button_press
    new_time = utime.ticks_ms()
    if (new_time - prev_button_press) > 250:    #debounce
        button_c +=1
        print(f'UP Button Presses: {button_c}')
        prev_button_press = new_time

def button_DOWN_pressed(pin):   #ISR
    global prev_button_press
    new_time = utime.ticks_ms()
    if (new_time - prev_button_press) > 250:    #debounce
        print(f'RP2040 Die Temp: {read_temp():.1f}')
        prev_button_press = new_time

def read_temp():
    data = sensor_RP2040_die_temp.read_u16() * adc_conversion_factor
    # Typically, Vbe = 0.706V @ 27Â°C, with a slope of -1.721mV (0.001721) per degree. 
    RP2040_die_temp = 27 - (data - 0.706)/0.001721
    return RP2040_die_temp

def oled_pixel_check():
    oled.fill(1)
    oled.show()
    utime.sleep(2)
    oled.fill(0)
    oled.show()
    
def oled_test():
    oled_pixel_check()
    for i in range(10):
        oled.fill(0)   #clears screen
        oled.text("Hello my name is", 0, 0)
        oled.text("PCB badge", 0, 10)
        oled.text("RP2040 Die Temp:", 0, 30)
        oled.text(f'{read_temp():.1f}', 0, 40)
        oled.show()
        utime.sleep(1)
    fb = framebuf.FrameBuffer(name_ms, 128, 64, framebuf.MONO_HLSB)
    oled.blit(fb, 0, 0)   
    oled.show()
    
def RGB_test():
    #RGB's don't work.
    pass

def unit_test():
    #button_test()
    #button_test_irq()
    #print(read_temp())
    oled_test()
    
    print('Unit testing complete')

#---------------------------MAIN-----------------------------------
def main():
    utime.sleep(1)   #wait for serial terminal
    print("'Hello my name is' PCB badge unit test")
    button_SW4_UP.irq(trigger=machine.Pin.IRQ_FALLING,  handler=button_UP_pressed)
    button_SW5_DOWN.irq(trigger=machine.Pin.IRQ_FALLING,  handler=button_DOWN_pressed)
    
    unit_test()

if __name__ == "__main__":
    main()
#------------------------------------------------------------------
'''
OLED 'Are RGB LEDs working, press up?'
OLed 'Are lights green press down?'
'''